# 回收計費系統 - 業務流程圖

## 系統總覽

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        回收計費系統 - 核心流程                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   每日作業          月結作業           收付款追蹤         合約管理          │
│   ─────────        ─────────          ──────────        ─────────          │
│   排程匯入 ───────▶ 產生報表 ────────▶ 狀態追蹤 ◀─────── 價格管理          │
│   交易紀錄          通知發送           逾期提醒           到期提醒          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 一、每日作業流程

### 1.1 排程匯入流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          排程匯入流程                                     │
└──────────────────────────────────────────────────────────────────────────┘

  ┌──────────────┐
  │ 既有排程系統  │  ← 公司內部已有的系統
  │ (車次/趟數)   │
  └──────┬───────┘
         │ 匯出 CSV 檔案
         │ (日期、客戶、趟次、車號、司機)
         ▼
  ┌──────────────┐
  │  上傳 CSV    │
  │  到新系統     │
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐      ┌──────────────┐
  │  欄位對應    │ ───▶ │  客戶比對    │
  │  (自動/手動) │      │              │
  └──────────────┘      └──────┬───────┘
                               │
         ┌─────────────────────┼─────────────────────┐
         ▼                     ▼                     ▼
  ┌────────────┐        ┌────────────┐        ┌────────────┐
  │ 完全比對   │        │ 模糊比對   │        │ 無法比對   │
  │ → 自動關聯 │        │ → 選擇建議 │        │ → 建新客戶 │
  └─────┬──────┘        └─────┬──────┘        └─────┬──────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              ▼
                   ┌──────────────────┐
                   │  確認匯入預覽    │
                   └────────┬─────────┘
                            │
                            ▼
                   ┌──────────────────┐
                   │  建立交易紀錄    │
                   │  (待填品項)      │
                   └──────────────────┘
```

### 1.2 交易紀錄處理流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        交易紀錄處理流程                                   │
└──────────────────────────────────────────────────────────────────────────┘

                   ┌──────────────────┐
                   │  交易紀錄骨架    │
                   │  (含趟次資訊)    │
                   └────────┬─────────┘
                            │
                            ▼
                   ┌──────────────────┐
                   │  填入回收品項    │
                   │  (品名/數量)     │
                   └────────┬─────────┘
                            │
         ┌──────────────────┴──────────────────┐
         ▼                                     ▼
  ┌────────────────┐                   ┌────────────────┐
  │  檢查客戶合約  │                   │  無有效合約    │
  │  有效期內?     │                   │                │
  └───────┬────────┘                   └───────┬────────┘
          │                                    │
          ▼                                    │
  ┌────────────────┐                           │
  │  品項在合約內? │                           │
  └───────┬────────┘                           │
          │                                    │
    ┌─────┴─────┐                              │
    ▼           ▼                              ▼
┌────────┐  ┌────────┐                  ┌────────────┐
│ 是     │  │ 否     │                  │ 手動輸入   │
│ ↓      │  │ ↓      │                  │ 浮動價格   │
│ 自動   │  │ 手動   │                  │            │
│ 帶入   │  │ 輸入   │                  │ 標示:      │
│ 合約價 │  │ 浮動價 │                  │ "浮動價"   │
│        │  │        │                  │            │
│ 標示:  │  │ 標示:  │                  │            │
│"合約價"│  │"浮動價"│                  │            │
└───┬────┘  └───┬────┘                  └─────┬──────┘
    │           │                             │
    └───────────┼─────────────────────────────┘
                ▼
       ┌────────────────┐
       │  計算金額      │
       │                │
       │  正數 = 客戶   │
       │        付給公司│
       │  負數 = 公司   │
       │        付給客戶│
       └───────┬────────┘
               │
               ▼
       ┌────────────────┐
       │  儲存交易紀錄  │
       └────────────────┘
```

---

## 二、月結作業流程 (每月 15 日左右)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         月結作業流程                                      │
└──────────────────────────────────────────────────────────────────────────┘

                   ┌──────────────────┐
                   │  選擇結算月份    │
                   └────────┬─────────┘
                            │
                            ▼
                   ┌──────────────────┐
                   │  產生月結報表    │
                   └────────┬─────────┘
                            │
         ┌──────────────────┼──────────────────┐
         ▼                  ▼                  ▼
  ┌────────────┐     ┌────────────┐     ┌────────────┐
  │ 客戶對帳單 │     │ 內部彙總表 │     │ 計算彙總   │
  │            │     │            │     │            │
  │ • 依日期   │     │ • 全部客戶 │     │ • 應收總額 │
  │ • 依趟次   │     │ • 統計資料 │     │ • 應付總額 │
  │ • 品項明細 │     │            │     │ • 結餘金額 │
  └─────┬──────┘     └─────┬──────┘     └─────┬──────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           ▼
                ┌──────────────────┐
                │  產生 PDF/Excel  │
                └────────┬─────────┘
                         │
                         ▼
                ┌──────────────────┐
                │  建立待審核通知  │  ← 不自動發送！
                │                  │
                │  狀態: 待審核    │
                └────────┬─────────┘
                         │
                         ▼
                ┌──────────────────┐
                │  人工審核確認    │
                │                  │
                │  • 預覽內容      │
                │  • 檢查附件      │
                │  • 確認收件人    │
                └────────┬─────────┘
                         │
          ┌──────────────┴──────────────┐
          ▼                             ▼
   ┌────────────┐                ┌────────────┐
   │  單筆發送  │                │  批次發送  │
   │  (逐一確認)│                │  (全部發送)│
   └─────┬──────┘                └─────┬──────┘
         │                             │
         └──────────────┬──────────────┘
                        ▼
           ┌────────────────────────┐
           │      發送通知          │
           │                        │
           │  Email:                │
           │  • 帳單內容            │
           │  • 附加 PDF 對帳單     │
           │                        │
           │  LINE:                 │
           │  • 帳單摘要            │
           │  • 金額資訊            │
           └───────────┬────────────┘
                       │
                       ▼
           ┌────────────────────────┐
           │      手開發票          │  ← 系統外作業
           │                        │
           │  (依據對帳單資訊)      │
           └────────────────────────┘
```

---

## 三、收付款追蹤流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        收付款追蹤流程                                     │
└──────────────────────────────────────────────────────────────────────────┘

                   ┌──────────────────┐
                   │  月結帳單列表    │
                   └────────┬─────────┘
                            │
         ┌──────────────────┼──────────────────┐
         ▼                  ▼                  ▼
  ┌────────────┐     ┌────────────┐     ┌────────────┐
  │  應收帳款  │     │  應付帳款  │     │  全部帳款  │
  │  (客戶付)  │     │  (公司付)  │     │            │
  └─────┬──────┘     └─────┬──────┘     └────────────┘
        │                  │
        └────────┬─────────┘
                 ▼
        ┌────────────────┐
        │  帳單狀態      │
        └───────┬────────┘
                │
    ┌───────────┼───────────┐
    ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐
│ 未收款 │  │ 逾期   │  │ 已收款 │
│        │  │        │  │        │
│ 待追蹤 │  │ >N天   │  │ 完成   │
└───┬────┘  └───┬────┘  └────────┘
    │           │
    │           ▼
    │   ┌────────────────┐
    │   │  系統自動標示  │
    │   │  為「逾期」    │
    │   └───────┬────────┘
    │           │
    │           ▼
    │   ┌────────────────┐
    │   │  產生內部提醒  │
    │   │  通知內部人員  │
    │   └────────────────┘
    │
    ▼
┌────────────────┐
│  收到款項後    │
│                │
│  1. 標示已收款 │
│  2. 填入日期   │
│  3. 更新狀態   │
└────────────────┘
```

---

## 四、合約管理流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         合約管理流程                                      │
└──────────────────────────────────────────────────────────────────────────┘

                   ┌──────────────────┐
                   │  合約列表        │
                   └────────┬─────────┘
                            │
    ┌───────────────────────┼───────────────────────┐
    ▼                       ▼                       ▼
┌──────────┐          ┌──────────┐           ┌──────────┐
│ 有效合約 │          │ 即將到期 │           │ 已過期   │
│          │          │ (30天內) │           │          │
│ 可使用   │          │          │           │ 歷史紀錄 │
└────┬─────┘          └────┬─────┘           └──────────┘
     │                     │
     │                     ▼
     │              ┌────────────────┐
     │              │  系統產生提醒  │
     │              │  通知內部人員  │
     │              └────────────────┘
     │
     ▼
┌──────────────────────────────────────┐
│          合約價格自動帶入             │
├──────────────────────────────────────┤
│                                      │
│  交易輸入品項                        │
│       │                              │
│       ▼                              │
│  檢查是否在合約品項內                │
│       │                              │
│   ┌───┴───┐                          │
│   ▼       ▼                          │
│  是      否                          │
│   │       │                          │
│   ▼       ▼                          │
│ 帶入    手動輸入                     │
│ 合約價  浮動價                       │
│                                      │
└──────────────────────────────────────┘


┌──────────────────────────────────────┐
│           合約品項管理                │
├──────────────────────────────────────┤
│                                      │
│  合約                                │
│    │                                 │
│    ├── 品項 A: 紙箱    $3.5/kg       │
│    ├── 品項 B: 鋁罐   -$15/kg        │
│    ├── 品項 C: 塑膠    $2.0/kg       │
│    └── ...                           │
│                                      │
│  * 正數 = 客戶付費 (處理費)          │
│  * 負數 = 公司付費 (收購價)          │
│                                      │
└──────────────────────────────────────┘
```

---

## 五、通知系統流程

```
┌──────────────────────────────────────────────────────────────────────────┐
│                          通知系統流程                                     │
└──────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   通知觸發事件   │
                    └────────┬────────┘
                             │
       ┌─────────────────────┼─────────────────────┐
       ▼                     ▼                     ▼
┌────────────┐        ┌────────────┐        ┌────────────┐
│ 月結帳單   │        │ 未收款     │        │ 合約到期   │
│ 產生完成   │        │ 逾期提醒   │        │ 前30天     │
└─────┬──────┘        └─────┬──────┘        └─────┬──────┘
      │                     │                     │
      │                     │                     │
      └─────────────────────┼─────────────────────┘
                            ▼
                 ┌──────────────────┐
                 │  建立通知        │
                 │  狀態: 待審核    │
                 └────────┬─────────┘
                          │
                          ▼
                 ┌──────────────────┐
                 │  待審核列表      │
                 │                  │
                 │  顯示:           │
                 │  • 通知類型      │
                 │  • 收件人        │
                 │  • 內容預覽      │
                 │  • 附件          │
                 └────────┬─────────┘
                          │
                          ▼
                 ┌──────────────────┐
                 │  人工審核        │
                 │                  │
                 │  • 確認內容      │
                 │  • 修改 (如需要) │
                 │  • 決定發送      │
                 └────────┬─────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │ 發送     │   │ 批次發送 │   │ 取消     │
    └────┬─────┘   └────┬─────┘   └──────────┘
         │              │
         └──────┬───────┘
                ▼
       ┌────────────────┐
       │  依客戶設定    │
       │  選擇發送方式  │
       └───────┬────────┘
               │
   ┌───────────┼───────────┬───────────┐
   ▼           ▼           ▼           ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│ EMAIL  │ │  LINE  │ │  電話  │ │ 司機   │
│        │ │        │ │        │ │ 親送   │
│• 主旨  │ │• 訊息  │ │• 產生  │ │• 產生  │
│• 內文  │ │• 金額  │ │  待聯繫│ │  請款單│
│• PDF   │ │  摘要  │ │  清單  │ │• 可列印│
│  附件  │ │        │ │• 人工  │ │• 含地址│
│        │ │        │ │  撥打  │ │  明細  │
└───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │          │          │          │
    │          │          ▼          ▼
    │          │     ┌────────┐ ┌────────┐
    │          │     │ 標記   │ │ 標記   │
    │          │     │ 已聯繫 │ │ 已送達 │
    │          │     └───┬────┘ └───┬────┘
    │          │         │          │
    └──────────┴─────────┴──────────┘
               │
               ▼
       ┌────────────────┐
       │  記錄發送歷史  │
       │                │
       │  • 發送時間    │
       │  • 發送對象    │
       │  • 發送內容    │
       │  • 發送狀態    │
       │  • 發送方式    │
       └────────────────┘
```

---

## 六、系統不處理的項目

| 項目 | 說明 |
|------|------|
| 排程管理 | 使用既有排程系統，本系統只匯入資料 |
| 發票開立 | 手開發票，系統只提供對帳單 |
| ERP 立帳 | 第二階段擴充 |
| 庫存管理 | 不在範圍內 |
| 路線規劃 | 不在範圍內 |

---

## 七、待確認事項

| 項目 | 狀態 |
|------|------|
| 客戶資料 CSV 格式 | ✅ 已確認：20 個欄位（廠商名稱、ERP名稱、收付款類型...） |
| 車趟 CSV 格式 | 待取得範例檔案（排程系統匯出） |
| LINE 服務選擇 | ✅ 已確認：LINE Messaging API |
| 月結時間 | ✅ 已確認：每月 15 日左右 |
| 逾期天數 | 待確認：超過幾天算逾期 |
| 通知方式 | ✅ 已確認：LINE / MAIL / 電話 / 司機親送 |
